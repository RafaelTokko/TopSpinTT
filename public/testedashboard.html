<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Entre no TopSpinTT</title>
        <link rel="stylesheet" href="style/style.css">
        <link rel="stylesheet" href="style/pesquisa.css">
        <link rel="shortcut icon" type="imagex/png" href="./assets/logo/icone.png">
        <script src="./script/sessao.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <header>
            
            
            <nav>
                <div class="logo">
                    <a href="index.html"><img src="assets/logo/logo.png" alt="Logo"></a>
                </div>
                <div class="navbar">
                    <ul>
                        <li><a href="./index.html">Home</a></li>
                        <li><a href="./posts.html">Posts</a></li>
                        <li><a href="./sobremim.html">Sobre mim</a></li>
                        <li><a href="./estatisticas.html">Estatísticas</a></li>
                        
                    </ul>
                </div>
                <div id="usuario" class="login-cadastro">
                    <ul>
                        <li><a class="entrar" href="login.html">Entrar</a></li>
                        <li><a class="cadastrar" href="cadastro.html">Cadastre-se</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        
        <main>
            <button onclick="obterDadosGrafico()" style="height: 500px; width: 300px;">aaaaa</button>
            
            <div class="pesquisa" id="pesquisa">
                <div class="tela-pesquisa" style="height: 100vh;">
                    
                    <canvas id="regiaoGrafico"></canvas>
                    <canvas id="nivelGrafico"></canvas>
                </div>
            </div>
            <div class="overlay" id="popupOverlay">
                <div class="popup-card">
                    <h2>Você já respondeu a pesquisa</h2>
                    <p>Caso queira, você pode mudar as respostas que você já tinha enviado!</p>
                    <button onclick="fecharCard()">Atualizar as respostas!</button>
                </div>
            </div>
        </main>
        
        <footer>
            
        </footer>
    </body>
<script>
    let dashboard = [];
    function obterDadosGrafico() {
    console.log(`Recuperando resultados gerais`);

        fetch(`/resultados/geral`).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                                    dashboard = resposta;
                    console.log(resposta);
                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

function plotarGrafico(resposta) {
    // Gráfico de Regiões
    let labelRegiao = [];
    const coresPorRegiao = {
        'Norte': '#1abc9c',
        'Nordeste': '#f1c40f',
        'Centro-Oeste': '#e67e22',
        'Sudeste': '#2980b9',
        'Sul': '#8e44ad'
    };
    let backgroundColorsRegiao = [];
    let regiaoGrafico = {
        labels: labelRegiao,
        datasets: [{
            label: 'Regiões',
            data: [],
            backgroundColor: backgroundColorsRegiao,
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
    let regiao = resposta.regiao;
    // Primeiro, somamos todos os valores para saber o total
    let totalRegiao = 0;
    for (let i = 0; i < regiao.length; i++) {
        totalRegiao += regiao[i].total;
    }
    // Agora, para cada região, calculamos a porcentagem
    for (let i = 0; i < regiao.length; i++) {
        var registro = regiao[i];
        labelRegiao.push(registro.Regiao);
        // Calcula a porcentagem: (valor da região / total) * 100
        let porcentagem = totalRegiao > 0 ? ((registro.total / totalRegiao) * 100).toFixed(1) : 0;
        regiaoGrafico.datasets[0].data.push(porcentagem);
        backgroundColorsRegiao.push(coresPorRegiao[registro.Regiao] || '#cccccc');
    }

    // Gráfico de Níveis
    let labelNivel = [];
    let backgroundColorsNivel = ['#2980b9', '#27ae60', '#e67e22', '#c0392b'];
    let nivelGrafico = {
        labels: labelNivel,
        datasets: [{
            label: 'Níveis',
            data: [],
            backgroundColor: backgroundColorsNivel,
            borderColor: '#fff',
            borderWidth: 2
        }]
    };
    let niveis = resposta.niveis;
    // Soma total dos níveis
    let totalNivel = 0;
    for (let i = 0; i < niveis.length; i++) {
        totalNivel += niveis[i].total;
    }
    for (let i = 0; i < niveis.length; i++) {
        var nivel = niveis[i];
        labelNivel.push(nivel.Nivel);
        let porcentagem = totalNivel > 0 ? ((nivel.total / totalNivel) * 100).toFixed(1) : 0;
        nivelGrafico.datasets[0].data.push(porcentagem);
    }

    // Configuração dos gráficos
    const configRegiao = {
        type: 'pie',
        data: regiaoGrafico,
        options: {
            plugins: {
                legend: {
                    display: true,
                    position: 'left'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let index = context.dataIndex;
                            let valorAbsoluto = regiao[index] ? regiao[index].total : 0;
                            let value = context.parsed;
                            return `${label}: ${value}% (${valorAbsoluto})`;
                        }
                    }
                }
            }
        }
    };

    const configNivel = {
        type: 'bar',
        data: nivelGrafico,
        options: {
            plugins: {
                legend: {
                    display: false
                },
            }
        }
    };
    // Renderiza os dois gráficos
    new Chart(document.getElementById('regiaoGrafico'), configRegiao);
    new Chart(document.getElementById('nivelGrafico'), configNivel);
}

</script>
</html>