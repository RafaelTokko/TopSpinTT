<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entre no TopSpinTT</title>
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/estatisticas.css">
    <link rel="shortcut icon" type="imagex/png" href="./assets/logo/icone.png">
    <script src="./script/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="obterDadosGrafico()">
    <header>


        <nav>
            <div class="logo">
                <a href="index.html"><img src="assets/logo/logo.png" alt="Logo"></a>
            </div>
                <div class="navbar">
                    <ul>
                        <li><a href="./index.html">Home</a></li>
                        <li><a href="./posts.html">Posts</a></li>
                        <li><a href="./sobremim.html">Sobre mim</a></li>
                        <li><a href="./estatisticas.html">Estatísticas</a></li>

                    </ul>
                </div>
                <div id="usuario" class="login-cadastro">
                    <ul>
                        <li><a class="entrar" href="login.html">Entrar</a></li>
                        <li><a class="cadastrar" href="cadastro.html">Cadastre-se</a></li>
                    </ul>
                </div>
        </nav>
    </header>
    
    <main>
        <div class="pesquisa-banner">
            <div class="caixa-pesquisa">
                <h2>Responda o formulário e ajude o site a melhorar!</h2>
                <p>No final, também haverá dicas personalizadas para a sua evolução de acordo com o tipo de jogador que você é!</p>
                <button onclick="location.href='./pesquisa.html';">Iniciar pesquisa</button>
                <a href="#anchor">Veja as estatísticas dos atletas do nosso site</a>
            </div>
        </div>
        <div class="tela-graficos" id="anchor">
            <h1>Estatísticas Gerais</h1>
            <div class="info-cards">
                <h2>Regiões dos jogadores</h2>
                <div class="conteudo-info">
                    <div class="grafico">
                        <canvas id="regiaoGrafico"></canvas>
                    </div>
                    <div class="texto">
                        <p>Veja a distribuição geográfica dos jogadores que responderam à pesquisa. Isso pode ajudar a entender onde o tênis de mesa é mais popular e onde há mais oportunidades para eventos e competições.</p>
                        <p>A maior parte dos nossos jogadores são da Região: <span id="maiorRegiao"></span></p>
                    </div>
                </div>
            </div>
            <div class="info-cards">
                <h2>Nivel dos Jogadores</h2>
                <div class="conteudo-info">
                    <div class="grafico">
                        <canvas id="nivelGrafico"></canvas>
                    </div>
                    <div class="texto">
                        <p>Descubra como os participantes do site se distribuem entre os diferentes níveis de habilidade. Assim, você pode comparar seu progresso com outros jogadores e encontrar conteúdos adequados para o seu momento no tênis de mesa.</p>
                        <div class="valor" id="valor">
                            <p>A grande parte dos atletas do TopSpinTT são do nível: <span id="maiorNivel"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>

    </footer>
</body>
<script>
    validarSessao();
    let dashboard = [];
    function obterDadosGrafico() {
    console.log(`Recuperando resultados gerais`);
    let regiao = null;
    let niveis = null;

    fetch('/resultados/regioes')
        .then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                console.error('Nenhum dado encontrado ou erro na API (regioes)');
                return [];
            }
        })
        .then(function (dadosRegiao) {
            regiao = dadosRegiao || [];
            if (niveis !== null) {
                plotarGrafico({ regiao, niveis });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico (regioes): ${error.message}`);
        });

    fetch('/resultados/niveis')
        .then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                console.error('Nenhum dado encontrado ou erro na API (niveis)');
                return [];
            }
        })
        .then(function (dadosNiveis) {
            niveis = dadosNiveis || [];
            if (regiao !== null) {
                plotarGrafico({ regiao, niveis });
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico (niveis): ${error.message}`);
        });
    }

function plotarGrafico(resposta) {
    // Gráfico de Regiões
    console.log(`Plotando gráficos com os dados recebidos`);
    let labelRegiao = [];
    const coresPorRegiao = {
        'Norte': '#1abc9c',
        'Nordeste': '#f1c40f',
        'Centro-Oeste': '#e67e22',
        'Sudeste': '#2980b9',
        'Sul': '#8e44ad'
    };
    let backgroundColorsRegiao = [];
    let regiaoGrafico = {
        labels: labelRegiao,
        datasets: [{
            label: 'Regiões',
            data: [],
            backgroundColor: backgroundColorsRegiao,
            borderColor: '#1d1d1d',
            borderWidth: 1
        }]
    };
    let regiao = resposta.regiao;
    // Primeiro, somamos todos os valores para saber o total
    let totalRegiao = 0;
    for (let i = 0; i < regiao.length; i++) {
        totalRegiao += regiao[i].total;
    }
    // Agora, para cada região, calculamos a porcentagem
    for (let i = 0; i < regiao.length; i++) {
        var registro = regiao[i];
        labelRegiao.push(registro.Regiao);
        let porcentagem;
        if (totalRegiao > 0) {
            porcentagem = ((registro.total / totalRegiao) * 100).toFixed(1);
        } else {
            porcentagem = 0;
        }
        regiaoGrafico.datasets[0].data.push(porcentagem);
        backgroundColorsRegiao.push(coresPorRegiao[registro.Regiao] || '#cccccc');
    }

    // Gráfico de Níveis
    let labelNivel = [];
    let backgroundColorsNivel = ['#2980b9', '#27ae60', '#e67e22', '#c0392b'];
    let nivelGrafico = {
        labels: labelNivel,
        datasets: [{
            label: 'Níveis',
            data: [],
            backgroundColor: backgroundColorsNivel,
        }]
    };
    let niveis = resposta.niveis;
    // Soma total dos níveis
    let totalNivel = 0;
    for (let i = 0; i < niveis.length; i++) {
        totalNivel += niveis[i].total;
    }
    for (let i = 0; i < niveis.length; i++) {
        var nivel = niveis[i];
        labelNivel.push(nivel.Nivel);
        let porcentagem;
        if (totalNivel > 0) {
            porcentagem = ((nivel.total / totalNivel) * 100).toFixed(1);
        } else {
            porcentagem = 0;
        }
        nivelGrafico.datasets[0].data.push(porcentagem);
    }

    // Configuração dos gráficos
    const configRegiao = {
        type: 'pie',
        data: regiaoGrafico,
        options: {
            plugins: {
                legend: {
                    display: true,
                    position: 'left',
                    labels: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let index = context.dataIndex;
                            let valorAbsoluto;
                            if (regiao[index]) {
                                valorAbsoluto = regiao[index].total;
                            } else {
                                valorAbsoluto = 0;
                            }
                            let value = context.parsed;
                            return `${label}: ${value}% (${valorAbsoluto})`;
                        }
                    }
                }
            }
        }
    };

    const configNivel = {
        type: 'bar',
        data: nivelGrafico,
        options: {
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let index = context.dataIndex;
                            let valorAbsoluto;
                            if (regiao[index]) {
                                valorAbsoluto = regiao[index].total;
                            } else {
                                valorAbsoluto = 0;
                            }
                            let value = context.raw;
                            return `${label}: ${value}% (${valorAbsoluto})`;
                        }
                    },
                    bodyColor: '#fff'
                }
            },
            scales: {
            x: {
                ticks: {
                    color: '#fff' // Cor dos labels do eixo X
                }
            },
            y: {
                ticks: {
                    color: '#fff' // Cor dos números do eixo Y
                }
            }
            },
        }
    };
    // Renderiza os dois gráficos
    new Chart(document.getElementById('regiaoGrafico'), configRegiao);
    new Chart(document.getElementById('nivelGrafico'), configNivel);
}

</script>
</html>